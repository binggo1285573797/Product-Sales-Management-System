{% extends "base.html" %}

{% block title %}销量预测 - 商品销售管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2 mb-0">销量预测</h1>
        <p class="text-muted mb-0">AI智能预测未来销售趋势</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshPrediction()">
                <i class="fas fa-sync-alt me-1"></i>刷新
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="runPrediction()">
                <i class="fas fa-crystal-ball me-1"></i>开始预测
            </button>
        </div>
    </div>
</div>

<!-- 预测说明 -->
<div class="alert alert-info">
    <h5><i class="fas fa-robot me-2"></i>AI智能预测说明</h5>
    <p class="mb-0">
        系统采用AI智能分析技术，基于近6个月的历史销售数据、市场趋势和季节性因素，
        使用先进的机器学习算法预测未来1个月各商品种类的销量趋势。
        预测结果包括销量预测值、需求等级（高/中/低）、置信度和AI分析理由，
        帮助您更准确地制定采购和销售策略。
    </p>
</div>

<!-- 预测结果 -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">预测结果</h6>
                <div class="text-muted small" id="predictionDate">
                    <!-- 预测日期将在这里显示 -->
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>商品种类</th>
                                <th>预测销量</th>
                                <th>需求等级</th>
                                <th>增长率</th>
                                <th>预测方式</th>
                                <th>预测时间</th>
                            </tr>
                        </thead>
                        <tbody id="predictionTableBody">
                            <tr>
                                <td colspan="6" class="text-center">暂无预测数据，请点击"开始预测"按钮</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预测图表 -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">预测销量对比</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预测历史 -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">预测历史</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>预测日期</th>
                                <th>商品种类</th>
                                <th>预测销量</th>
                                <th>需求等级</th>
                                <th>增长率</th>
                                <th>预测时间</th>
                            </tr>
                        </thead>
                        <tbody id="predictionHistoryTable">
                            <tr>
                                <td colspan="6" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chart-area {
    position: relative;
    height: 20rem;
    width: 100%;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let predictionChart;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    loadPredictionHistory();
});

// 初始化图表
function initChart() {
    const ctx = document.getElementById('predictionChart').getContext('2d');
    predictionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '预测销量',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// 运行预测
function runPrediction() {
    const btn = document.querySelector('button[onclick="runPrediction()"]');
    const originalText = btn.innerHTML;
    showLoading(btn);
    
    // 直接使用完整路径，不经过API_BASE
    fetch('/ai/prediction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(async (response) => {
            hideLoading(btn, originalText);
            
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                const data = await response.json();
                console.log('预测接口响应:', data); // 调试信息
                
                if (data.code === 1) {
                    showMessage('预测完成', 'success');
                    const predictions = data.data.predictions;
                    console.log('预测结果:', predictions); // 调试信息
                    
                    displayPredictionResults(predictions);
                    updatePredictionChart(predictions);
                    document.getElementById('predictionDate').textContent = `预测日期：${data.data.prediction_date}`;
                    loadPredictionHistory();
                } else {
                    showMessage(data.msg, 'danger');
                }
            } else {
                const text = await response.text();
                showMessage(`服务器错误: ${text.slice(0, 200)}`, 'danger');
            }
        })
        .catch(error => {
            hideLoading(btn, originalText);
            console.error('预测请求失败:', error);
            showMessage('预测请求失败，请稍后重试', 'danger');
        });
}

// 显示预测结果
function displayPredictionResults(predictions) {
    console.log('正在显示预测结果:', predictions); // 调试信息
    const tbody = document.getElementById('predictionTableBody');
    
    if (predictions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无预测数据</td></tr>';
        return;
    }
    
    tbody.innerHTML = predictions.map(pred => {
        // 详细调试信息
        console.log(`处理预测: ${pred.category_name}, growth_rate = ${pred.growth_rate}, 类型 = ${typeof pred.growth_rate}`);
        
        // 安全处理增长率字段（统一显示为百分比格式）
        let growthRateDisplay = '-';
        if (pred.growth_rate !== null && pred.growth_rate !== undefined) {
            const growthRate = parseFloat(pred.growth_rate);
            console.log(`预测解析后的增长率: ${growthRate}`);
            if (!isNaN(growthRate)) {
                // 统一显示为百分比格式
                growthRateDisplay = (growthRate * 100).toFixed(1) + '%';
            } else {
                console.warn(`预测增长率解析失败: ${pred.growth_rate}`);
            }
        } else {
            console.warn(`预测增长率为空: ${pred.growth_rate}`);
        }
        
        // 安全处理置信度字段
        let confidenceDisplay = '';
        if (pred.confidence !== null && pred.confidence !== undefined) {
            const confidence = parseFloat(pred.confidence);
            if (!isNaN(confidence)) {
                confidenceDisplay = `<br><small class="text-muted">置信度: ${(confidence * 100).toFixed(1)}%</small>`;
            }
        }
        
        return `
            <tr>
                <td>${pred.category_name}</td>
                <td><span class="badge bg-primary">${pred.predicted_sales}</span></td>
                <td><span class="badge bg-${getDemandLevelColor(pred.demand_level)}">${getDemandLevelText(pred.demand_level)}</span></td>
                <td>${growthRateDisplay}</td>
                <td>
                    ${pred.ai_enhanced ? 
                        '<span class="badge bg-success"><i class="fas fa-robot me-1"></i>AI预测</span>' : 
                        '<span class="badge bg-secondary">传统预测</span>'
                    }
                    ${confidenceDisplay}
                </td>
                <td>${new Date().toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</td>
            </tr>
        `;
    }).join('');
    
    console.log('预测结果表格已更新'); // 调试信息
}

// 更新预测图表
function updatePredictionChart(predictions) {
    const labels = predictions.map(p => p.category_name);
    const data = predictions.map(p => p.predicted_sales);
    
    predictionChart.data.labels = labels;
    predictionChart.data.datasets[0].data = data;
    predictionChart.update();
}

// 获取需求等级颜色
function getDemandLevelColor(level) {
    const colors = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'success'
    };
    return colors[level] || 'secondary';
}

// 获取需求等级文本
function getDemandLevelText(level) {
    const texts = {
        'high': '高需求',
        'medium': '中需求',
        'low': '低需求'
    };
    return texts[level] || level;
}

// 加载预测历史
function loadPredictionHistory() {
    // 直接使用完整路径，不经过API_BASE
    fetch('/ai/prediction-history', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(async (response) => {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                const data = await response.json();
                console.log('预测历史接口响应:', data); // 调试信息
                
                if (data.code === 1) {
                    const history = data.data.history;
                    console.log('预测历史数据:', history); // 调试信息
                    displayPredictionHistory(history);
                } else {
                    showMessage(data.msg, 'danger');
                }
            } else {
                const text = await response.text();
                showMessage(`加载历史失败: ${text.slice(0, 200)}`, 'danger');
            }
        })
        .catch(error => {
            console.error('预测历史请求失败:', error);
            showMessage('加载预测历史失败', 'danger');
        });
}

// 显示预测历史
function displayPredictionHistory(history) {
    console.log('正在显示预测历史:', history); // 调试信息
    const tbody = document.getElementById('predictionHistoryTable');
    
    if (!history || history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无预测历史</td></tr>';
        return;
    }
    
    tbody.innerHTML = history.map(item => {
        // 详细调试信息
        console.log(`处理记录: ${item.category_name}, growth_rate = ${item.growth_rate}, 类型 = ${typeof item.growth_rate}`);
        
        // 安全处理增长率字段（统一显示为百分比格式）
        let growthRateDisplay = '-';
        if (item.growth_rate !== null && item.growth_rate !== undefined) {
            const growthRate = parseFloat(item.growth_rate);
            console.log(`解析后的增长率: ${growthRate}`);
            if (!isNaN(growthRate)) {
                // 统一显示为百分比格式
                growthRateDisplay = (growthRate * 100).toFixed(1) + '%';
            } else {
                console.warn(`增长率解析失败: ${item.growth_rate}`);
            }
        } else {
            console.warn(`增长率为空: ${item.growth_rate}`);
        }
        
        return `
            <tr>
                <td>${new Date(item.prediction_date).toLocaleDateString('zh-CN', {year: 'numeric', month: 'numeric', day: 'numeric'})}</td>
                <td>${item.category_name || '未知'}</td>
                <td><span class="badge bg-primary">${item.predicted_sales}</span></td>
                <td><span class="badge bg-${getDemandLevelColor(item.demand_level)}">${getDemandLevelText(item.demand_level)}</span></td>
                <td>${growthRateDisplay}</td>
                <td>${new Date(item.create_time).toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</td>
            </tr>
        `;
    }).join('');
    
    console.log('预测历史表格已更新'); // 调试信息
}

// 刷新预测
function refreshPrediction() {
    loadPredictionHistory();
    showMessage('预测数据已刷新', 'success');
}
</script>
{% endblock %}

