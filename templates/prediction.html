{% extends "base.html" %}

{% block title %}销量预测 - 商品销售管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">销量预测</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshPrediction()">
                <i class="fas fa-sync-alt me-1"></i>刷新
            </button>
        </div>
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="runPrediction()">
                <i class="fas fa-crystal-ball me-1"></i>开始预测
            </button>
        </div>
    </div>
</div>

<!-- 预测说明 -->
<div class="alert alert-info">
    <h5><i class="fas fa-info-circle me-2"></i>预测说明</h5>
    <p class="mb-0">
        系统将基于近6个月的历史销售数据，使用移动平均算法预测未来1个月各商品种类的销量趋势。
        预测结果包括销量预测值和需求等级（高/中/低），帮助您更好地制定采购和销售策略。
    </p>
</div>

<!-- 预测结果 -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">预测结果</h6>
                <div class="text-muted small" id="predictionDate">
                    <!-- 预测日期将在这里显示 -->
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>商品种类</th>
                                <th>预测销量</th>
                                <th>需求等级</th>
                                <th>增长率</th>
                                <th>预测时间</th>
                            </tr>
                        </thead>
                        <tbody id="predictionTableBody">
                            <tr>
                                <td colspan="5" class="text-center">暂无预测数据，请点击"开始预测"按钮</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预测图表 -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">预测销量对比</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预测历史 -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">预测历史</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>预测日期</th>
                                <th>商品种类</th>
                                <th>预测销量</th>
                                <th>需求等级</th>
                                <th>预测时间</th>
                            </tr>
                        </thead>
                        <tbody id="predictionHistoryTable">
                            <tr>
                                <td colspan="5" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chart-area {
    position: relative;
    height: 20rem;
    width: 100%;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let predictionChart;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    loadPredictionHistory();
});

// 初始化图表
function initChart() {
    const ctx = document.getElementById('predictionChart').getContext('2d');
    predictionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '预测销量',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// 运行预测
function runPrediction() {
    const btn = document.querySelector('button[onclick="runPrediction()"]');
    const originalText = btn.innerHTML;
    showLoading(btn);
    
    apiRequest('/ai/prediction', 'POST')
        .then(response => {
            hideLoading(btn, originalText);
            
            if (response.code === 1) {
                showMessage('预测完成', 'success');
                displayPredictionResults(response.data.predictions);
                updatePredictionChart(response.data.predictions);
                document.getElementById('predictionDate').textContent = `预测日期：${response.data.prediction_date}`;
                loadPredictionHistory();
            } else {
                showMessage(response.msg, 'danger');
            }
        });
}

// 显示预测结果
function displayPredictionResults(predictions) {
    const tbody = document.getElementById('predictionTableBody');
    
    if (predictions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">暂无预测数据</td></tr>';
        return;
    }
    
    tbody.innerHTML = predictions.map(pred => `
        <tr>
            <td>${pred.category_name}</td>
            <td><span class="badge bg-primary">${pred.predicted_sales}</span></td>
            <td><span class="badge bg-${getDemandLevelColor(pred.demand_level)}">${getDemandLevelText(pred.demand_level)}</span></td>
            <td>${pred.growth_rate ? pred.growth_rate.toFixed(1) + '%' : '-'}</td>
            <td>${new Date().toLocaleString()}</td>
        </tr>
    `).join('');
}

// 更新预测图表
function updatePredictionChart(predictions) {
    const labels = predictions.map(p => p.category_name);
    const data = predictions.map(p => p.predicted_sales);
    
    predictionChart.data.labels = labels;
    predictionChart.data.datasets[0].data = data;
    predictionChart.update();
}

// 获取需求等级颜色
function getDemandLevelColor(level) {
    const colors = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'success'
    };
    return colors[level] || 'secondary';
}

// 获取需求等级文本
function getDemandLevelText(level) {
    const texts = {
        'high': '高需求',
        'medium': '中需求',
        'low': '低需求'
    };
    return texts[level] || level;
}

// 加载预测历史
function loadPredictionHistory() {
    apiRequest('/ai/prediction-history')
        .then(response => {
            if (response.code === 1) {
                displayPredictionHistory(response.data);
            } else {
                showMessage(response.msg, 'danger');
            }
        });
}

// 显示预测历史
function displayPredictionHistory(history) {
    const tbody = document.getElementById('predictionHistoryTable');
    
    if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">暂无预测历史</td></tr>';
        return;
    }
    
    tbody.innerHTML = history.map(item => `
        <tr>
            <td>${item.prediction_date}</td>
            <td>${item.category_name}</td>
            <td><span class="badge bg-primary">${item.predicted_sales}</span></td>
            <td><span class="badge bg-${getDemandLevelColor(item.demand_level)}">${getDemandLevelText(item.demand_level)}</span></td>
            <td>${new Date(item.create_time).toLocaleString()}</td>
        </tr>
    `).join('');
}

// 刷新预测
function refreshPrediction() {
    loadPredictionHistory();
    showMessage('预测数据已刷新', 'success');
}
</script>
{% endblock %}

